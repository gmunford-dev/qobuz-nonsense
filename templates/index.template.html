<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qobuz Nonsense</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --surface2: #1c1c26;
    --border: #2a2a3a;
    --accent: #c27aff;
    --accent2: #7ac2ff;
    --danger: #ff5e5e;
    --warn: #ffb347;
    --ok: #5effa8;
    --muted: #6b6b88;
    --text: #e8e8f0;
    --text2: #a0a0c0;
    --radius: 10px;
    --font: 'Inter', system-ui, -apple-system, sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font);
    font-size: 14px;
    line-height: 1.5;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* â”€â”€ Header â”€â”€ */
  header {
    background: linear-gradient(135deg, #1a0a2e 0%, #0d1a2e 100%);
    border-bottom: 1px solid var(--border);
    padding: 20px 28px 16px;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .logo-icon {
    width: 34px; height: 34px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
  }
  .logo h1 {
    font-size: 20px;
    font-weight: 700;
    letter-spacing: -0.5px;
  }
  .logo h1 span { color: var(--accent); }
  .header-meta {
    font-size: 12px;
    color: var(--muted);
    text-align: right;
  }
  #last-updated { color: var(--accent2); }

  /* â”€â”€ Stats bar â”€â”€ */
  .stats-bar {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }
  .stat {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .stat-value {
    font-size: 22px;
    font-weight: 700;
    color: var(--accent);
    line-height: 1;
  }
  .stat-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-divider { width: 1px; background: var(--border); align-self: stretch; margin: 2px 0; }

  /* â”€â”€ Layout â”€â”€ */
  .app {
    display: grid;
    grid-template-columns: 260px 1fr;
    min-height: calc(100vh - 100px);
    max-width: 1600px;
    margin: 0 auto;
    width: 100%;
    box-sizing: border-box;
  }

  /* â”€â”€ Sidebar â”€â”€ */
  aside {
    border-right: 1px solid var(--border);
    padding: 20px 16px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    background: var(--surface);
    position: sticky;
    top: 100px;
    height: calc(100vh - 100px);
    overflow-y: auto;
  }
  .filter-section h3 {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--muted);
    margin-bottom: 8px;
  }
  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .filter-chip {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 10px;
    border-radius: 6px;
    cursor: pointer;
    user-select: none;
    transition: background 0.15s;
    font-size: 13px;
  }
  .filter-chip:hover { background: var(--surface2); }
  .filter-chip.active { background: var(--surface2); }
  .filter-chip input[type=checkbox] { display: none; }
  .filter-chip .chip-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .filter-chip .chip-count {
    margin-left: auto;
    font-size: 11px;
    color: var(--muted);
  }

  /* Narrative colors */
  .dot-royalties { background: #7ac2ff; }
  .dot-quality { background: #c27aff; }
  .dot-anti-ceo { background: #ff5e5e; }
  .dot-boycott-israel { background: #ffb347; }
  .dot-degoogle { background: #5effa8; }
  .dot-anti-spotify { background: #ff7ac2; }
  .dot-pro-indie { background: #fff07a; }
  .dot-switch-recommendation { background: #c2ffa0; }

  /* Source colors */
  .dot-reddit { background: #ff5700; }
  .dot-news { background: #4a9eff; }
  .dot-twitter { background: #1da1f2; }
  .dot-hackernews { background: #ff6600; }

  /* Platform colors */
  .dot-spotify { background: #1ed760; }
  .dot-amazon { background: #ff9900; }
  .dot-apple { background: #a0a0a0; }
  .dot-youtube { background: #ff0000; }
  .dot-tidal { background: #00ffff; }
  .dot-deezer { background: #a238ff; }
  .dot-generic { background: #6b6b88; }

  /* Language colors */
  .dot-lang-en { background: #4a9eff; }
  .dot-lang-fr { background: #0055a4; }
  .dot-lang-de { background: #dd0000; }
  .dot-lang-es { background: #ffc400; }
  .dot-lang-pt { background: #006600; }
  .dot-lang-it { background: #009246; }
  .dot-lang-nl { background: #ff6600; }

  .search-input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 7px 10px;
    color: var(--text);
    font-size: 13px;
    outline: none;
    transition: border-color 0.15s;
  }
  .search-input:focus { border-color: var(--accent); }

  .bot-range {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .bot-range input[type=range] {
    width: 100%;
    accent-color: var(--accent);
  }
  .bot-range-label {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--muted);
  }

  .archive-select {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 7px 10px;
    color: var(--text);
    font-size: 13px;
    outline: none;
    cursor: pointer;
  }

  .reset-btn {
    width: 100%;
    padding: 8px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
    margin-top: 4px;
  }
  .reset-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* â”€â”€ Main content â”€â”€ */
  main {
    padding: 20px 24px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    min-width: 0;       /* KEY: allows grid cell to respect 1fr â€” prevents Chart.js canvas feedback loop */
    overflow-x: hidden;
  }

  /* â”€â”€ Chart â”€â”€ */
  .chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px 20px;
  }
  .chart-card h2 {
    font-size: 13px;
    font-weight: 600;
    color: var(--text2);
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .chart-container { height: 160px; position: relative; overflow: hidden; }
  .chart-container--tall { height: 220px; }

  /* â”€â”€ Results info bar â”€â”€ */
  .results-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
  }
  .results-count { font-size: 13px; color: var(--text2); }
  .results-count strong { color: var(--text); }
  .sort-select {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 5px 10px;
    color: var(--text);
    font-size: 12px;
    outline: none;
    cursor: pointer;
  }

  /* â”€â”€ Post cards â”€â”€ */
  .posts-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .post-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px;
    transition: border-color 0.15s, transform 0.1s;
  }
  .post-card:hover {
    border-color: var(--accent);
    transform: translateY(-1px);
  }
  .post-card.high-bot {
    border-color: rgba(255, 94, 94, 0.4);
    background: linear-gradient(135deg, var(--surface), rgba(255,94,94,0.04));
  }

  .card-header {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    margin-bottom: 8px;
  }
  .source-badge {
    flex-shrink: 0;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }
  .source-reddit { background: rgba(255,87,0,0.2); color: #ff7733; }
  .source-news { background: rgba(74,158,255,0.2); color: #6ab4ff; }
  .source-twitter { background: rgba(29,161,242,0.2); color: #4ab8ff; }

  .card-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    flex: 1;
    line-height: 1.3;
  }
  .card-title a {
    color: inherit;
    text-decoration: none;
  }
  .card-title a:hover { color: var(--accent); }

  .card-meta {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 8px;
    font-size: 12px;
    color: var(--muted);
  }
  .meta-author { color: var(--text2); }
  .meta-subreddit { color: var(--accent2); }
  .meta-date {}
  .meta-score { color: var(--ok); }

  .card-text {
    font-size: 13px;
    color: var(--text2);
    line-height: 1.5;
    margin-bottom: 10px;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-footer {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* Narrative pills */
  .narrative-pill {
    padding: 2px 8px;
    border-radius: 99px;
    font-size: 11px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .pill-royalties { background: rgba(122,194,255,0.15); color: #7ac2ff; }
  .pill-quality { background: rgba(194,122,255,0.15); color: #c27aff; }
  .pill-anti-ceo { background: rgba(255,94,94,0.15); color: #ff8080; }
  .pill-boycott-israel { background: rgba(255,179,71,0.15); color: #ffb347; }
  .pill-degoogle { background: rgba(94,255,168,0.15); color: #5effa8; }
  .pill-anti-spotify { background: rgba(255,122,194,0.15); color: #ff7ac2; }
  .pill-pro-indie { background: rgba(255,240,122,0.15); color: #fff07a; }
  .pill-switch-recommendation { background: rgba(194,255,160,0.15); color: #c2ffa0; }

  /* Platform-from badge */
  .platform-badge {
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
  }
  .platform-spotify { background: rgba(30,215,96,0.15); color: #1ed760; }
  .platform-amazon { background: rgba(255,153,0,0.15); color: #ff9900; }
  .platform-apple { background: rgba(160,160,160,0.15); color: #c0c0c0; }
  .platform-youtube { background: rgba(255,0,0,0.15); color: #ff4444; }
  .platform-tidal { background: rgba(0,255,255,0.15); color: #00dddd; }
  .platform-generic { background: rgba(107,107,136,0.15); color: #8888aa; }

  /* Bot score indicator */
  .bot-indicator {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
  }
  .bot-high { background: rgba(255,94,94,0.2); color: var(--danger); }
  .bot-medium { background: rgba(255,179,71,0.2); color: var(--warn); }
  .bot-low { background: rgba(107,107,136,0.1); color: var(--muted); }
  .bot-dot { width: 6px; height: 6px; border-radius: 50%; }
  .bot-high .bot-dot { background: var(--danger); }
  .bot-medium .bot-dot { background: var(--warn); }
  .bot-low .bot-dot { background: var(--muted); }

  /* Account age indicator */
  .acct-age {
    font-size: 11px;
    color: var(--muted);
  }
  .acct-age.new-acct { color: var(--warn); }

  /* â”€â”€ Month dividers â”€â”€ */
  .month-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 8px 0 4px;
  }
  .month-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }
  .month-line {
    flex: 1;
    height: 1px;
    background: var(--border);
  }
  .month-count {
    font-size: 11px;
    color: var(--muted);
    white-space: nowrap;
  }

  /* â”€â”€ Empty state â”€â”€ */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }
  .empty-icon { font-size: 48px; margin-bottom: 12px; }

  /* â”€â”€ Load more â”€â”€ */
  .load-more-btn {
    width: 100%;
    padding: 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text2);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .load-more-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* â”€â”€ Scrollbar â”€â”€ */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

  /* â”€â”€ Burst banner â”€â”€ */
  .burst-banner {
    background: rgba(255,179,71,0.1);
    border: 1px solid rgba(255,179,71,0.35);
    border-radius: var(--radius);
    padding: 12px 16px;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    color: var(--warn);
    font-size: 13px;
  }
  .burst-banner-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
  .burst-banner-list { display: flex; flex-direction: column; gap: 4px; }

  /* â”€â”€ Author panel â”€â”€ */
  .author-panel-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.55);
    z-index: 200;
  }
  .author-panel-overlay.open { display: block; }
  .author-panel {
    position: fixed;
    right: 0; top: 0; bottom: 0;
    width: 380px;
    background: var(--surface);
    border-left: 1px solid var(--border);
    z-index: 201;
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.25s ease;
  }
  .author-panel.open { transform: translateX(0); }
  .author-panel-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }
  .author-panel-title { font-size: 15px; font-weight: 700; }
  .author-panel-close {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 18px;
    padding: 4px 8px;
    border-radius: 4px;
    line-height: 1;
  }
  .author-panel-close:hover { color: var(--text); background: var(--surface2); }
  .author-panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }
  .author-stat-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  .author-stat {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
  }
  .author-stat-val { font-size: 18px; font-weight: 700; color: var(--accent); line-height: 1.2; }
  .author-stat-key { font-size: 11px; color: var(--muted); margin-top: 3px; }
  .author-section-title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--muted);
    margin-bottom: 6px;
  }
  .author-signal-list { display: flex; flex-wrap: wrap; gap: 5px; }
  .author-signal {
    background: var(--surface2);
    border-radius: 4px;
    padding: 3px 8px;
    font-size: 11px;
    color: var(--text2);
  }
  .author-post-mini {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    font-size: 12px;
    line-height: 1.4;
  }
  .author-post-mini a { color: var(--accent2); text-decoration: none; }
  .author-post-mini a:hover { text-decoration: underline; }
  .author-post-mini .post-date { color: var(--muted); font-size: 11px; margin-top: 4px; }

  /* â”€â”€ CSV export button â”€â”€ */
  .csv-export-btn {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 5px 10px;
    color: var(--text2);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .csv-export-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* â”€â”€ Direction accent on cards â”€â”€ */
  .post-card.direction-critical { border-left: 3px solid #ffaa44; }
  .post-card.direction-pro { border-left: 3px solid rgba(194,255,160,0.35); }

  /* Criticism narrative dot/pill colors */
  .dot-app-issues { background: #ff9966; }
  .dot-catalog-gaps { background: #ffcc44; }
  .dot-service-issues { background: #ff8844; }
  .dot-pricing-complaints { background: #ffa033; }
  .pill-app-issues { background: rgba(255,153,102,0.15); color: #ff9966; }
  .pill-catalog-gaps { background: rgba(255,204,68,0.15); color: #ffcc44; }
  .pill-service-issues { background: rgba(255,136,68,0.15); color: #ff8844; }
  .pill-pricing-complaints { background: rgba(255,160,51,0.15); color: #ffa033; }

  /* â”€â”€ Top posts panel â”€â”€ */
  .top-posts-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px 20px;
  }
  .top-posts-card h2 {
    font-size: 13px; font-weight: 600; color: var(--text2);
    margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;
  }
  .top-post-item {
    display: flex; gap: 12px; align-items: flex-start;
    padding: 10px 0; border-bottom: 1px solid var(--border);
  }
  .top-post-item:last-child { border-bottom: none; }
  .top-post-rank { font-size: 20px; font-weight: 800; color: var(--muted); width: 24px; flex-shrink: 0; line-height: 1.2; }
  .top-post-body { flex: 1; min-width: 0; }
  .top-post-title { font-size: 13px; font-weight: 600; color: var(--text); line-height: 1.3; margin-bottom: 4px; }
  .top-post-title a { color: inherit; text-decoration: none; }
  .top-post-title a:hover { color: var(--accent); }
  .top-post-meta { font-size: 11px; color: var(--muted); display: flex; gap: 8px; flex-wrap: wrap; }

  /* â”€â”€ Two-column layout â”€â”€ */
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .two-col > * { min-width: 0; }

  /* â”€â”€ Subreddit breakdown â”€â”€ */
  .subreddit-table-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px 20px;
  }
  .subreddit-table-card h2 {
    font-size: 13px; font-weight: 600; color: var(--text2);
    margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;
  }
  .subreddit-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 5px 0; border-bottom: 1px solid var(--border); font-size: 12px;
  }
  .subreddit-row:last-child { border-bottom: none; }
  .subreddit-name { color: var(--accent2); }
  .subreddit-bar-wrap { flex: 1; height: 4px; background: var(--border); border-radius: 2px; margin: 0 10px; }
  .subreddit-bar { height: 4px; background: var(--accent); border-radius: 2px; }
  .subreddit-count { font-weight: 600; color: var(--text); }

  /* â”€â”€ Velocity badge â”€â”€ */
  .velocity-badge { font-size: 11px; font-weight: 600; padding: 1px 5px; border-radius: 4px; margin-left: 4px; }
  .velocity-up { background: rgba(94,255,168,0.15); color: var(--ok); }
  .velocity-down { background: rgba(255,94,94,0.15); color: var(--danger); }
  .velocity-flat { background: rgba(107,107,136,0.15); color: var(--muted); }

  /* â”€â”€ Language badge â”€â”€ */
  .lang-badge {
    flex-shrink: 0;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.3px;
    margin-left: 4px;
  }
  .lang-fr { background: rgba(0,85,164,0.2); color: #5599dd; }
  .lang-de { background: rgba(221,0,0,0.2); color: #ee6666; }
  .lang-es { background: rgba(255,196,0,0.2); color: #ffcc44; }
  .lang-pt { background: rgba(0,102,0,0.2); color: #44aa44; }
  .lang-it { background: rgba(0,146,70,0.2); color: #44bb66; }
  .lang-nl { background: rgba(255,102,0,0.2); color: #ff8844; }
  .lang-unknown { background: rgba(107,107,136,0.2); color: var(--muted); }

  .translated-indicator {
    font-size: 11px;
    color: var(--muted);
    font-style: italic;
    margin-bottom: 2px;
  }

  /* â”€â”€ Hacker News source badge â”€â”€ */
  .source-hackernews { background: rgba(255,102,0,0.2); color: #ff8833; }

  /* â”€â”€ Deezer platform â”€â”€ */
  .platform-deezer { background: rgba(162,56,255,0.15); color: #a238ff; }
</style>
</head>
<body>

<header>
  <div class="header-top">
    <div class="logo">
      <div class="logo-icon">ğŸ”</div>
      <h1>Qobuz <span>Nonsense</span></h1>
    </div>
    <div class="header-meta">
      Last updated: <span id="last-updated">â€”</span><br>
      Auto-refreshes every 3 hours
    </div>
  </div>
  <div class="stats-bar">
    <div class="stat">
      <div class="stat-value" id="stat-total">â€”</div>
      <div class="stat-label">Total Posts</div>
    </div>
    <div class="stat-divider"></div>
    <div class="stat">
      <div class="stat-value" id="stat-week">â€”</div>
      <div class="stat-label">This Week <span id="stat-velocity"></span></div>
    </div>
    <div class="stat-divider"></div>
    <div class="stat">
      <div class="stat-value" id="stat-bot" style="color: var(--danger)">â€”</div>
      <div class="stat-label">High Bot Suspicion</div>
    </div>
    <div class="stat-divider"></div>
    <div class="stat">
      <div class="stat-value" id="stat-critical" style="color: #ffaa44">â€”</div>
      <div class="stat-label">Critical Posts</div>
    </div>
    <div class="stat-divider"></div>
    <div class="stat">
      <div class="stat-value" id="stat-top-narrative" style="color: var(--accent2); font-size:14px">â€”</div>
      <div class="stat-label">Top Narrative</div>
    </div>
    <div class="stat-divider"></div>
    <div class="stat">
      <div class="stat-value" id="stat-languages" style="color: var(--accent2)">â€”</div>
      <div class="stat-label">Languages</div>
    </div>
  </div>
</header>

<div class="app">

  <aside>
    <!-- Search -->
    <div class="filter-section">
      <h3>Search</h3>
      <input type="text" class="search-input" id="search-input" placeholder="Filter by keywordâ€¦">
    </div>

    <!-- Source filter -->
    <div class="filter-section">
      <h3>Source</h3>
      <div class="filter-group" id="filter-source">
        <label class="filter-chip active" data-filter="source" data-value="all">
          <input type="checkbox" checked>
          <span class="chip-dot" style="background: var(--muted)"></span>
          All Sources
          <span class="chip-count" id="count-source-all">â€”</span>
        </label>
        <label class="filter-chip" data-filter="source" data-value="reddit">
          <input type="checkbox">
          <span class="chip-dot dot-reddit"></span>
          Reddit
          <span class="chip-count" id="count-source-reddit">0</span>
        </label>
        <label class="filter-chip" data-filter="source" data-value="news">
          <input type="checkbox">
          <span class="chip-dot dot-news"></span>
          News
          <span class="chip-count" id="count-source-news">0</span>
        </label>
        <label class="filter-chip" data-filter="source" data-value="hackernews">
          <input type="checkbox">
          <span class="chip-dot dot-hackernews"></span>
          Hacker News
          <span class="chip-count" id="count-source-hackernews">0</span>
        </label>
        <label class="filter-chip" data-filter="source" data-value="twitter">
          <input type="checkbox">
          <span class="chip-dot dot-twitter"></span>
          X / Twitter
          <span class="chip-count" id="count-source-twitter">0</span>
        </label>
      </div>
    </div>

    <!-- Direction filter -->
    <div class="filter-section">
      <h3>Direction</h3>
      <div class="filter-group" id="filter-direction">
        <label class="filter-chip active" data-filter="direction" data-value="all">
          <input type="checkbox" checked>
          <span class="chip-dot" style="background: var(--muted)"></span>
          All
          <span class="chip-count" id="count-direction-all">â€”</span>
        </label>
        <label class="filter-chip" data-filter="direction" data-value="pro">
          <input type="checkbox">
          <span class="chip-dot" style="background: #c2ffa0"></span>
          Pro-Qobuz
          <span class="chip-count" id="count-direction-pro">0</span>
        </label>
        <label class="filter-chip" data-filter="direction" data-value="critical">
          <input type="checkbox">
          <span class="chip-dot" style="background: #ffaa44"></span>
          Critical
          <span class="chip-count" id="count-direction-critical">0</span>
        </label>
        <label class="filter-chip" data-filter="direction" data-value="neutral">
          <input type="checkbox">
          <span class="chip-dot" style="background: var(--muted)"></span>
          Neutral
          <span class="chip-count" id="count-direction-neutral">0</span>
        </label>
      </div>
    </div>

    <!-- Language filter -->
    <div class="filter-section">
      <h3>Language</h3>
      <div class="filter-group" id="filter-language">
        <label class="filter-chip active" data-filter="language" data-value="all">
          <input type="checkbox" checked>
          <span class="chip-dot" style="background: var(--muted)"></span>
          All Languages
          <span class="chip-count" id="count-lang-all">--</span>
        </label>
        <label class="filter-chip" data-filter="language" data-value="en">
          <input type="checkbox">
          <span class="chip-dot dot-lang-en"></span>
          English
          <span class="chip-count" id="count-lang-en">0</span>
        </label>
        <label class="filter-chip" data-filter="language" data-value="fr">
          <input type="checkbox">
          <span class="chip-dot dot-lang-fr"></span>
          Francais
          <span class="chip-count" id="count-lang-fr">0</span>
        </label>
        <label class="filter-chip" data-filter="language" data-value="de">
          <input type="checkbox">
          <span class="chip-dot dot-lang-de"></span>
          Deutsch
          <span class="chip-count" id="count-lang-de">0</span>
        </label>
        <label class="filter-chip" data-filter="language" data-value="es">
          <input type="checkbox">
          <span class="chip-dot dot-lang-es"></span>
          Espanol
          <span class="chip-count" id="count-lang-es">0</span>
        </label>
        <label class="filter-chip" data-filter="language" data-value="pt">
          <input type="checkbox">
          <span class="chip-dot dot-lang-pt"></span>
          Portugues
          <span class="chip-count" id="count-lang-pt">0</span>
        </label>
        <label class="filter-chip" data-filter="language" data-value="it">
          <input type="checkbox">
          <span class="chip-dot dot-lang-it"></span>
          Italiano
          <span class="chip-count" id="count-lang-it">0</span>
        </label>
      </div>
    </div>

    <!-- Platform filter -->
    <div class="filter-section">
      <h3>Switching From</h3>
      <div class="filter-group" id="filter-platform">
        <label class="filter-chip active" data-filter="platform" data-value="all">
          <input type="checkbox" checked>
          <span class="chip-dot" style="background: var(--muted)"></span>
          All Platforms
          <span class="chip-count"></span>
        </label>
        <label class="filter-chip" data-filter="platform" data-value="spotify">
          <input type="checkbox">
          <span class="chip-dot dot-spotify"></span>
          Spotify
          <span class="chip-count" id="count-platform-spotify">0</span>
        </label>
        <label class="filter-chip" data-filter="platform" data-value="amazon">
          <input type="checkbox">
          <span class="chip-dot dot-amazon"></span>
          Amazon
          <span class="chip-count" id="count-platform-amazon">0</span>
        </label>
        <label class="filter-chip" data-filter="platform" data-value="apple">
          <input type="checkbox">
          <span class="chip-dot dot-apple"></span>
          Apple Music
          <span class="chip-count" id="count-platform-apple">0</span>
        </label>
        <label class="filter-chip" data-filter="platform" data-value="youtube">
          <input type="checkbox">
          <span class="chip-dot dot-youtube"></span>
          YouTube Music
          <span class="chip-count" id="count-platform-youtube">0</span>
        </label>
        <label class="filter-chip" data-filter="platform" data-value="tidal">
          <input type="checkbox">
          <span class="chip-dot dot-tidal"></span>
          Tidal
          <span class="chip-count" id="count-platform-tidal">0</span>
        </label>
        <label class="filter-chip" data-filter="platform" data-value="deezer">
          <input type="checkbox">
          <span class="chip-dot dot-deezer"></span>
          Deezer
          <span class="chip-count" id="count-platform-deezer">0</span>
        </label>
        <label class="filter-chip" data-filter="platform" data-value="generic">
          <input type="checkbox">
          <span class="chip-dot dot-generic"></span>
          Generic / Other
          <span class="chip-count" id="count-platform-generic">0</span>
        </label>
      </div>
    </div>

    <!-- Narrative filter -->
    <div class="filter-section">
      <h3>Narrative</h3>
      <div class="filter-group" id="filter-narrative">
        <label class="filter-chip active" data-filter="narrative" data-value="all">
          <input type="checkbox" checked>
          <span class="chip-dot" style="background: var(--muted)"></span>
          All Narratives
          <span class="chip-count"></span>
        </label>
        <label class="filter-chip" data-filter="narrative" data-value="switch-recommendation">
          <span class="chip-dot dot-switch-recommendation"></span>
          Switch Rec.
          <span class="chip-count" id="count-n-switch-recommendation">0</span>
        </label>
        <label class="filter-chip" data-filter="narrative" data-value="anti-spotify">
          <span class="chip-dot dot-anti-spotify"></span>
          Anti-Spotify
          <span class="chip-count" id="count-n-anti-spotify">0</span>
        </label>
        <label class="filter-chip" data-filter="narrative" data-value="royalties">
          <span class="chip-dot dot-royalties"></span>
          Artist Pay
          <span class="chip-count" id="count-n-royalties">0</span>
        </label>
        <label class="filter-chip" data-filter="narrative" data-value="quality">
          <span class="chip-dot dot-quality"></span>
          Sound Quality
          <span class="chip-count" id="count-n-quality">0</span>
        </label>
        <label class="filter-chip" data-filter="narrative" data-value="anti-ceo">
          <span class="chip-dot dot-anti-ceo"></span>
          Anti-CEO
          <span class="chip-count" id="count-n-anti-ceo">0</span>
        </label>
        <label class="filter-chip" data-filter="narrative" data-value="boycott-israel">
          <span class="chip-dot dot-boycott-israel"></span>
          Boycott Israel
          <span class="chip-count" id="count-n-boycott-israel">0</span>
        </label>
        <label class="filter-chip" data-filter="narrative" data-value="degoogle">
          <span class="chip-dot dot-degoogle"></span>
          DeGoogle / Privacy
          <span class="chip-count" id="count-n-degoogle">0</span>
        </label>
        <label class="filter-chip" data-filter="narrative" data-value="pro-indie">
          <span class="chip-dot dot-pro-indie"></span>
          Pro-Indie
          <span class="chip-count" id="count-n-pro-indie">0</span>
        </label>
        <label class="filter-chip" data-filter="narrative" data-value="app-issues">
          <span class="chip-dot dot-app-issues"></span>
          App Issues
          <span class="chip-count" id="count-n-app-issues">0</span>
        </label>
        <label class="filter-chip" data-filter="narrative" data-value="catalog-gaps">
          <span class="chip-dot dot-catalog-gaps"></span>
          Catalog Gaps
          <span class="chip-count" id="count-n-catalog-gaps">0</span>
        </label>
        <label class="filter-chip" data-filter="narrative" data-value="service-issues">
          <span class="chip-dot dot-service-issues"></span>
          Service Issues
          <span class="chip-count" id="count-n-service-issues">0</span>
        </label>
        <label class="filter-chip" data-filter="narrative" data-value="pricing-complaints">
          <span class="chip-dot dot-pricing-complaints"></span>
          Pricing
          <span class="chip-count" id="count-n-pricing-complaints">0</span>
        </label>
      </div>
    </div>

    <!-- Bot suspicion threshold -->
    <div class="filter-section">
      <h3>Bot Suspicion â‰¥</h3>
      <div class="bot-range">
        <input type="range" id="bot-threshold" min="0" max="1" step="0.05" value="0">
        <div class="bot-range-label">
          <span>Any</span>
          <span id="bot-threshold-value">0%</span>
          <span>100%</span>
        </div>
      </div>
    </div>

    <!-- Archive month selector -->
    <div class="filter-section">
      <h3>Archive Month</h3>
      <select class="archive-select" id="archive-select">
        <option value="current">Current (last 30 days)</option>
      </select>
    </div>

    <button class="reset-btn" onclick="resetFilters()">Reset All Filters</button>
  </aside>

  <main>
    <!-- Coordinated burst warning banner (populated by JS when detected_bursts is non-empty) -->
    <div id="burst-banner" style="display:none"></div>

    <!-- Trends chart -->
    <div class="chart-card">
      <h2>Narrative Trends â€” Posts per Month (Last 6 Months)</h2>
      <div class="chart-container chart-container--tall">
        <canvas id="trends-chart"></canvas>
      </div>
    </div>

    <!-- Sentiment balance chart -->
    <div class="chart-card">
      <h2>Pro vs. Critical â€” Sentiment Balance (Last 6 Months)</h2>
      <div class="chart-container">
        <canvas id="sentiment-chart"></canvas>
      </div>
    </div>

    <!-- Top posts this week + Subreddit breakdown -->
    <div class="two-col">
      <div class="top-posts-card">
        <h2>ğŸ”¥ Top Posts This Week</h2>
        <div id="top-posts-list"></div>
      </div>
      <div class="subreddit-table-card">
        <h2>By Subreddit</h2>
        <div id="subreddit-table"></div>
      </div>
    </div>

    <!-- Source + Language breakdown -->
    <div class="two-col">
      <div class="chart-card">
        <h2>By Source</h2>
        <div class="chart-container" style="height:180px">
          <canvas id="source-chart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <h2>By Language</h2>
        <div class="chart-container" style="height:180px">
          <canvas id="language-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Results bar -->
    <div class="results-bar">
      <div class="results-count">
        Showing <strong id="visible-count">â€”</strong> of <strong id="total-count">â€”</strong> posts
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="csv-export-btn" onclick="exportCSV()">â¬‡ Export CSV</button>
        <select class="sort-select" id="sort-select">
          <option value="date-desc">Newest First</option>
          <option value="date-asc">Oldest First</option>
          <option value="score-desc">Highest Score</option>
          <option value="bot-desc">Highest Bot Score</option>
          <option value="engagement-desc">Most Engagement</option>
        </select>
      </div>
    </div>

    <!-- Posts list -->
    <div class="posts-list" id="posts-list"></div>

    <!-- Load more -->
    <button class="load-more-btn" id="load-more-btn" onclick="loadMore()" style="display:none">
      Load more posts
    </button>
  </main>
</div>

<script>
// â”€â”€ Data (injected by build_site.py) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const POSTS_DATA = __POSTS_DATA__;
const METADATA = __METADATA__;
const ARCHIVE_MONTHS = __ARCHIVE_MONTHS__;

// â”€â”€ Signal labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SIGNAL_LABELS = {
  'very_new_account':        'Account < 30 days old',
  'new_account':             'Account < 90 days old',
  'very_low_karma':          'Under 10 karma',
  'low_karma':               'Under 100 karma',
  'new_and_low_karma':       'New account + low karma',
  'odd_hour_post':           'Posted 2â€“6am UTC',
  'copy_paste_campaign':     'Near-identical text in 3+ posts',
  'similar_to_other_posts':  'Similar text found elsewhere',
  'username_pattern':        'Scripted-looking username',
  'numeric_username_suffix': 'Long number suffix in username',
};

// â”€â”€ Language mappings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LANG_FLAGS = { en: 'EN', fr: 'FR', de: 'DE', es: 'ES', pt: 'PT', it: 'IT', nl: 'NL' };
const LANG_NAMES = { en: 'English', fr: 'French', de: 'German', es: 'Spanish', pt: 'Portuguese', it: 'Italian', nl: 'Dutch', unknown: 'Unknown' };

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allPosts = [];
let filteredPosts = [];
let displayedCount = 0;
const PAGE_SIZE = 30;

let activeFilters = {
  source: 'all',
  platform: 'all',
  narrative: 'all',
  direction: 'all',
  language: 'all',
  botMin: 0,
  search: '',
  sort: 'date-desc',
};

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  allPosts = POSTS_DATA;

  // Populate header stats
  document.getElementById('last-updated').textContent = formatDate(METADATA.last_updated);
  document.getElementById('stat-total').textContent = METADATA.total_posts?.toLocaleString() || allPosts.length;
  document.getElementById('stat-week').textContent = METADATA.posts_this_week?.toLocaleString() || 'â€”';
  document.getElementById('stat-bot').textContent = METADATA.high_bot_suspicion_count?.toLocaleString() || 'â€”';

  // Top narrative
  const narratives = METADATA.by_narrative || {};
  const topNarrative = Object.entries(narratives).sort((a,b) => b[1]-a[1])[0];
  document.getElementById('stat-top-narrative').textContent = topNarrative
    ? narrativeName(topNarrative[0]) + ' (' + topNarrative[1] + ')'
    : 'â€”';

  // Critical posts count
  const criticalCount = (METADATA.by_direction || {}).critical || 0;
  document.getElementById('stat-critical').textContent = criticalCount.toLocaleString();

  // Languages stat
  const langCount = Object.keys(METADATA.by_language || {}).length;
  document.getElementById('stat-languages').textContent = langCount;

  // Populate counts in sidebar
  updateSidebarCounts(allPosts);

  // Populate archive dropdown
  const archiveSelect = document.getElementById('archive-select');
  ARCHIVE_MONTHS.forEach(month => {
    const opt = document.createElement('option');
    opt.value = month;
    opt.textContent = formatMonth(month);
    archiveSelect.appendChild(opt);
  });

  // Build trends chart + sentiment chart
  buildChart();
  buildSentimentChart();

  // Top posts + subreddit breakdown + source/language charts
  buildTopPostsPanel();
  buildSubredditTable();
  buildSourceChart();
  buildLanguageChart();

  // Velocity indicator
  displayVelocity();

  // Burst warning banner
  if (METADATA.detected_bursts && METADATA.detected_bursts.length > 0) {
    const banner = document.getElementById('burst-banner');
    banner.className = 'burst-banner';
    banner.style.display = 'flex';
    const items = METADATA.detected_bursts.map(b => {
      const hrs = b.window_hours || 72;
      return `<div>Coordinated burst detected: <strong>${narrativeName(b.narrative)}</strong> â€” ${b.count} posts in ~${hrs}h (${formatDate(b.start).split(',')[0]})</div>`;
    }).join('');
    banner.innerHTML = `<div class="burst-banner-icon">âš </div><div class="burst-banner-list">${items}</div>`;
  }

  // Bind events
  document.getElementById('search-input').addEventListener('input', e => {
    activeFilters.search = e.target.value.toLowerCase();
    applyFilters();
  });

  document.getElementById('bot-threshold').addEventListener('input', e => {
    activeFilters.botMin = parseFloat(e.target.value);
    document.getElementById('bot-threshold-value').textContent = Math.round(activeFilters.botMin * 100) + '%';
    applyFilters();
  });

  document.getElementById('sort-select').addEventListener('change', e => {
    activeFilters.sort = e.target.value;
    applyFilters();
  });

  // Author panel click delegation
  document.getElementById('posts-list').addEventListener('click', e => {
    const link = e.target.closest('.author-link');
    if (link) openAuthorPanel(link.dataset.author);
  });

  // ESC closes author panel
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeAuthorPanel();
  });

  document.getElementById('archive-select').addEventListener('change', async e => {
    if (e.target.value === 'current') {
      allPosts = POSTS_DATA;
    } else {
      allPosts = await loadArchive(e.target.value);
    }
    updateSidebarCounts(allPosts);
    applyFilters();
  });

  // Filter chip clicks
  document.querySelectorAll('.filter-chip[data-filter]').forEach(chip => {
    chip.addEventListener('click', () => {
      const filterType = chip.dataset.filter;
      const value = chip.dataset.value;

      document.querySelectorAll(`.filter-chip[data-filter="${filterType}"]`).forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      activeFilters[filterType === 'source' ? 'source' : filterType === 'platform' ? 'platform' : filterType === 'direction' ? 'direction' : filterType === 'language' ? 'language' : 'narrative'] = value;
      applyFilters();
    });
  });

  applyFilters();
}

// â”€â”€ Archive loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadArchive(month) {
  try {
    const resp = await fetch(`data/archive/${month}.json`);
    if (!resp.ok) return [];
    return await resp.json();
  } catch(e) {
    console.error('Archive load error:', e);
    return [];
  }
}

// â”€â”€ Filtering & sorting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyFilters() {
  let posts = allPosts;

  if (activeFilters.source !== 'all') {
    posts = posts.filter(p => p.source === activeFilters.source);
  }
  if (activeFilters.platform !== 'all') {
    posts = posts.filter(p => p.platform_from === activeFilters.platform);
  }
  if (activeFilters.narrative !== 'all') {
    posts = posts.filter(p => (p.narratives || []).includes(activeFilters.narrative));
  }
  if (activeFilters.direction !== 'all') {
    posts = posts.filter(p => (p.direction || 'neutral') === activeFilters.direction);
  }
  if (activeFilters.language !== 'all') {
    posts = posts.filter(p => (p.language || 'en') === activeFilters.language);
  }
  if (activeFilters.botMin > 0) {
    posts = posts.filter(p => (p.bot_score || 0) >= activeFilters.botMin);
  }
  if (activeFilters.search) {
    const q = activeFilters.search;
    posts = posts.filter(p =>
      (p.title || '').toLowerCase().includes(q) ||
      (p.text || '').toLowerCase().includes(q) ||
      (p.title_original || '').toLowerCase().includes(q) ||
      (p.text_original || '').toLowerCase().includes(q) ||
      (p.author || '').toLowerCase().includes(q) ||
      (p.subreddit || '').toLowerCase().includes(q)
    );
  }

  // Sort
  posts = [...posts];
  const sort = activeFilters.sort;
  if (sort === 'date-desc') posts.sort((a,b) => (b.date||'').localeCompare(a.date||''));
  else if (sort === 'date-asc') posts.sort((a,b) => (a.date||'').localeCompare(b.date||''));
  else if (sort === 'score-desc') posts.sort((a,b) => (b.score||0) - (a.score||0));
  else if (sort === 'bot-desc') posts.sort((a,b) => (b.bot_score||0) - (a.bot_score||0));
  else if (sort === 'engagement-desc') posts.sort((a,b) => ((b.score||0) + (b.num_comments||0)*2) - ((a.score||0) + (a.num_comments||0)*2));

  filteredPosts = posts;
  displayedCount = 0;

  document.getElementById('total-count').textContent = posts.length.toLocaleString();
  renderPosts();
}

// â”€â”€ Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPosts() {
  const container = document.getElementById('posts-list');
  if (displayedCount === 0) container.innerHTML = '';

  const batch = filteredPosts.slice(displayedCount, displayedCount + PAGE_SIZE);
  displayedCount += batch.length;

  if (filteredPosts.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ”</div><div>No posts match your filters.</div></div>`;
    document.getElementById('load-more-btn').style.display = 'none';
    document.getElementById('visible-count').textContent = '0';
    return;
  }

  // Group by month for dividers
  let lastMonth = null;

  batch.forEach(post => {
    const postMonth = (post.date || '').substring(0, 7);

    if (postMonth !== lastMonth) {
      const monthCount = filteredPosts.filter(p => (p.date||'').startsWith(postMonth)).length;
      const divider = document.createElement('div');
      divider.className = 'month-header';
      divider.innerHTML = `
        <div class="month-label">${formatMonth(postMonth)}</div>
        <div class="month-line"></div>
        <div class="month-count">${monthCount} post${monthCount !== 1 ? 's' : ''}</div>
      `;
      container.appendChild(divider);
      lastMonth = postMonth;
    }

    container.appendChild(buildCard(post));
  });

  document.getElementById('visible-count').textContent = displayedCount.toLocaleString();
  document.getElementById('load-more-btn').style.display = displayedCount < filteredPosts.length ? 'block' : 'none';
}

function loadMore() {
  renderPosts();
}

function buildCard(post) {
  const card = document.createElement('div');
  const botScore = post.bot_score || 0;
  const dir = post.direction || 'neutral';
  card.className = 'post-card' + (botScore >= 0.6 ? ' high-bot' : '') +
    (dir === 'critical' ? ' direction-critical' : dir === 'pro' ? ' direction-pro' : '');

  const botClass = botScore >= 0.6 ? 'bot-high' : botScore >= 0.35 ? 'bot-medium' : 'bot-low';
  const botLabel = botScore >= 0.6 ? 'ğŸ¤– Bot suspect' : botScore >= 0.35 ? 'âš  Possible bot' : 'âœ“ Likely human';

  const narrativePills = (post.narratives || []).map(n =>
    `<span class="narrative-pill pill-${n}">${narrativeName(n)}</span>`
  ).join('');

  const platformBadge = post.platform_from && post.platform_from !== 'generic'
    ? `<span class="platform-badge platform-${post.platform_from}">â† ${platformName(post.platform_from)}</span>`
    : '';

  const ageDays = post.author_age_days;
  const ageLabel = ageDays !== null && ageDays !== undefined
    ? (ageDays < 30 ? `<span class="acct-age new-acct">âš¡ ${ageDays}d old acct</span>`
      : ageDays < 90 ? `<span class="acct-age new-acct">${ageDays}d acct</span>`
      : '')
    : '';

  const subredditLabel = post.subreddit
    ? `<span class="meta-subreddit">${post.subreddit}</span>` : '';

  const karma = post.author_karma !== null && post.author_karma !== undefined
    ? `Â· ${Number(post.author_karma).toLocaleString()} karma` : '';

  const score = post.score > 0
    ? `<span class="meta-score">â–² ${Number(post.score).toLocaleString()}</span>` : '';

  const comments = post.num_comments > 0
    ? `<span>ğŸ’¬ ${Number(post.num_comments).toLocaleString()}</span>` : '';

  const signals = (post.bot_signals || []).length > 0
    ? `<div style="margin-top:6px; display:flex; flex-wrap:wrap; gap:4px">` +
      (post.bot_signals).map(s => `<span style="font-size:11px; background:var(--surface2); border-radius:4px; padding:2px 7px; color:var(--text2)">${SIGNAL_LABELS[s] || s}</span>`).join('') +
      `</div>`
    : '';

  const lang = post.language || 'en';
  const langBadge = lang !== 'en'
    ? `<span class="lang-badge lang-${lang}" title="Translated from ${LANG_NAMES[lang] || lang}">${(LANG_FLAGS[lang] || lang).toUpperCase()}</span>`
    : '';
  const translatedLine = post.title_original
    ? `<div class="translated-indicator">Translated from ${LANG_NAMES[lang] || lang}</div>`
    : '';

  card.innerHTML = `
    <div class="card-header">
      <span class="source-badge source-${post.source}">${post.source}</span>${langBadge}
      <div class="card-title">
        <a href="${escHtml(post.url)}" target="_blank" rel="noopener">${escHtml(post.title || post.text?.substring(0,120) || '(no title)')}</a>
      </div>
    </div>
    ${translatedLine}
    <div class="card-meta">
      <span class="meta-author author-link" data-author="${escHtml(post.author || 'unknown')}" style="cursor:pointer; text-decoration:underline dotted; text-underline-offset:2px">@${escHtml(post.author || 'unknown')}</span>
      ${subredditLabel}
      ${ageLabel}
      ${karma ? `<span>${escHtml(karma)}</span>` : ''}
      <span class="meta-date">${formatDate(post.date)}</span>
      ${score}
      ${comments}
    </div>
    ${post.text && post.text !== post.title ? `<div class="card-text">${escHtml(post.text)}</div>` : ''}
    <div class="card-footer">
      ${platformBadge}
      ${narrativePills}
      <div class="bot-indicator ${botClass}" title="${(post.bot_signals||[]).join(', ') || 'No signals'}">
        <div class="bot-dot"></div>
        ${botLabel} (${Math.round(botScore * 100)}%)
      </div>
    </div>
    ${signals}
  `;
  return card;
}

// â”€â”€ Sidebar counts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateSidebarCounts(posts) {
  const countEl = id => document.getElementById(id);

  // Source counts
  ['reddit', 'news', 'hackernews', 'twitter'].forEach(s => {
    const el = countEl(`count-source-${s}`);
    if (el) el.textContent = posts.filter(p => p.source === s).length;
  });
  const allEl = countEl('count-source-all');
  if (allEl) allEl.textContent = posts.length;

  // Platform counts
  ['spotify', 'amazon', 'apple', 'youtube', 'tidal', 'deezer', 'generic'].forEach(p => {
    const el = countEl(`count-platform-${p}`);
    if (el) el.textContent = posts.filter(post => post.platform_from === p).length;
  });

  // Language counts
  ['en','fr','de','es','pt','it'].forEach(l => {
    const el = countEl(`count-lang-${l}`);
    if (el) el.textContent = posts.filter(p => (p.language || 'en') === l).length;
  });
  const langAllEl = countEl('count-lang-all');
  if (langAllEl) langAllEl.textContent = posts.length;

  // Narrative counts
  ['royalties','quality','anti-ceo','boycott-israel','degoogle','anti-spotify','pro-indie','switch-recommendation',
   'app-issues','catalog-gaps','service-issues','pricing-complaints'].forEach(n => {
    const el = countEl(`count-n-${n}`);
    if (el) el.textContent = posts.filter(p => (p.narratives||[]).includes(n)).length;
  });

  // Direction counts
  ['pro', 'critical', 'neutral'].forEach(d => {
    const el = countEl(`count-direction-${d}`);
    if (el) el.textContent = posts.filter(p => (p.direction || 'neutral') === d).length;
  });
  const dirAllEl = countEl('count-direction-all');
  if (dirAllEl) dirAllEl.textContent = posts.length;
}

// â”€â”€ Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildChart() {
  const byMonth = METADATA.by_narrative_by_month || buildNarrativeByMonth(allPosts);

  // Get last 6 months
  const months = getLast6Months();
  const narrativeKeys = ['switch-recommendation','anti-spotify','royalties','quality','anti-ceo','boycott-israel'];
  const colors = ['#c2ffa0','#ff7ac2','#7ac2ff','#c27aff','#ff8080','#ffb347'];

  const datasets = narrativeKeys.map((nk, i) => ({
    label: narrativeName(nk),
    data: months.map(m => (byMonth[m] || {})[nk] || 0),
    borderColor: colors[i],
    backgroundColor: colors[i] + '22',
    tension: 0.3,
    fill: false,
    pointRadius: 3,
  }));

  new Chart(document.getElementById('trends-chart'), {
    type: 'line',
    data: {
      labels: months.map(m => formatMonth(m)),
      datasets,
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: '#a0a0c0', font: { size: 11 }, boxWidth: 12 },
        },
      },
      scales: {
        x: { ticks: { color: '#6b6b88', font: { size: 10 } }, grid: { color: '#2a2a3a' } },
        y: { ticks: { color: '#6b6b88', font: { size: 10 } }, grid: { color: '#2a2a3a' } },
      },
    },
  });
}

function buildNarrativeByMonth(posts) {
  const result = {};
  posts.forEach(p => {
    const month = (p.date || '').substring(0, 7);
    if (!month) return;
    if (!result[month]) result[month] = {};
    (p.narratives || []).forEach(n => {
      result[month][n] = (result[month][n] || 0) + 1;
    });
  });
  return result;
}

function getLast6Months() {
  const months = [];
  const now = new Date();
  for (let i = 5; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    months.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`);
  }
  return months;
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetFilters() {
  activeFilters = { source: 'all', platform: 'all', narrative: 'all', direction: 'all', language: 'all', botMin: 0, search: '', sort: 'date-desc' };
  document.getElementById('search-input').value = '';
  document.getElementById('bot-threshold').value = 0;
  document.getElementById('bot-threshold-value').textContent = '0%';
  document.getElementById('sort-select').value = 'date-desc';
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.filter-chip[data-value="all"]').forEach(c => c.classList.add('active'));
  document.getElementById('archive-select').value = 'current';
  allPosts = POSTS_DATA;
  updateSidebarCounts(allPosts);
  applyFilters();
}

function narrativeName(key) {
  return {
    'royalties': 'Artist Pay',
    'quality': 'Sound Quality',
    'anti-ceo': 'Anti-CEO',
    'boycott-israel': 'Boycott Israel',
    'degoogle': 'DeGoogle',
    'anti-spotify': 'Anti-Spotify',
    'pro-indie': 'Pro-Indie',
    'switch-recommendation': 'Switch Rec.',
    'app-issues': 'App Issues',
    'catalog-gaps': 'Catalog Gaps',
    'service-issues': 'Service Issues',
    'pricing-complaints': 'Pricing',
  }[key] || key;
}

function platformName(key) {
  return {
    'spotify': 'Spotify',
    'amazon': 'Amazon Music',
    'apple': 'Apple Music',
    'youtube': 'YouTube Music',
    'tidal': 'Tidal',
    'deezer': 'Deezer',
    'generic': 'Generic',
  }[key] || key;
}

function formatDate(iso) {
  if (!iso) return 'â€”';
  try {
    return new Date(iso).toLocaleDateString('en-US', {
      month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
    });
  } catch(e) { return iso; }
}

function formatMonth(ym) {
  if (!ym || ym.length < 7) return ym || 'â€”';
  const [y, m] = ym.split('-');
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${months[parseInt(m,10)-1]} ${y}`;
}

function escHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

// â”€â”€ Author panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAuthorPanel(author) {
  const panel = document.getElementById('author-panel');
  const overlay = document.getElementById('author-panel-overlay');
  const titleEl = document.getElementById('author-panel-title');
  const body = document.getElementById('author-panel-body');

  titleEl.textContent = '@' + author;

  const authorPosts = allPosts
    .filter(p => p.author === author)
    .sort((a,b) => (b.date||'').localeCompare(a.date||''));

  if (authorPosts.length === 0) {
    body.innerHTML = `<div style="color:var(--muted);text-align:center;padding:40px 0">No posts found for this author.</div>`;
  } else {
    const sample = authorPosts[0];
    const botScore = sample.bot_score || 0;
    const botClass = botScore >= 0.6 ? 'bot-high' : botScore >= 0.35 ? 'bot-medium' : 'bot-low';
    const botLabel = botScore >= 0.6 ? 'ğŸ¤– Bot suspect' : botScore >= 0.35 ? 'âš  Possible bot' : 'âœ“ Likely human';

    const narrativeCounts = {};
    authorPosts.forEach(p => (p.narratives||[]).forEach(n => {
      narrativeCounts[n] = (narrativeCounts[n]||0) + 1;
    }));
    const topNarratives = Object.entries(narrativeCounts)
      .sort((a,b) => b[1]-a[1])
      .map(([n,c]) => `<span class="author-signal">${narrativeName(n)} Ã—${c}</span>`)
      .join('');

    const signalHtml = (sample.bot_signals||[])
      .map(s => `<span class="author-signal">${SIGNAL_LABELS[s]||s}</span>`)
      .join('');

    const ageLabel = sample.author_age_days != null
      ? (sample.author_age_days < 90
          ? `<span style="color:var(--warn)">${sample.author_age_days}d old</span>`
          : `${sample.author_age_days}d old`)
      : 'â€”';

    const postItems = authorPosts.map(p => `
      <div class="author-post-mini">
        <a href="${escHtml(p.url)}" target="_blank" rel="noopener">${escHtml(p.title || (p.text||'').substring(0,100) || '(no title)')}</a>
        <div class="post-date">${formatDate(p.date)} Â· ${(p.narratives||[]).map(n => narrativeName(n)).join(', ') || 'â€”'}</div>
      </div>`).join('');

    body.innerHTML = `
      <div class="author-stat-row">
        <div class="author-stat">
          <div class="author-stat-val">${authorPosts.length}</div>
          <div class="author-stat-key">Posts in dataset</div>
        </div>
        <div class="author-stat">
          <div class="author-stat-val bot-indicator ${botClass}" style="font-size:12px;padding:0;background:none;gap:4px">${botLabel} ${Math.round(botScore*100)}%</div>
          <div class="author-stat-key">Bot suspicion</div>
        </div>
        <div class="author-stat">
          <div class="author-stat-val">${ageLabel}</div>
          <div class="author-stat-key">Account age</div>
        </div>
        <div class="author-stat">
          <div class="author-stat-val">${sample.author_karma != null ? Number(sample.author_karma).toLocaleString() : 'â€”'}</div>
          <div class="author-stat-key">Karma</div>
        </div>
      </div>
      ${signalHtml ? `<div><div class="author-section-title">Bot signals</div><div class="author-signal-list">${signalHtml}</div></div>` : ''}
      ${topNarratives ? `<div><div class="author-section-title">Narratives pushed</div><div class="author-signal-list">${topNarratives}</div></div>` : ''}
      <div>
        <div class="author-section-title">Posts (${authorPosts.length})</div>
        ${postItems}
      </div>`;
  }

  panel.classList.add('open');
  overlay.classList.add('open');
}

function closeAuthorPanel() {
  document.getElementById('author-panel').classList.remove('open');
  document.getElementById('author-panel-overlay').classList.remove('open');
}

// â”€â”€ CSV Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV() {
  const cols = ['date','source','type','language','author','subreddit','title','title_original','text','text_original','narratives','direction','platform_from','score','num_comments','bot_score','bot_signals','campaign_burst','url'];
  const rows = [cols.join(',')];
  filteredPosts.forEach(p => {
    const vals = cols.map(c => {
      let v = p[c];
      if (Array.isArray(v)) v = v.join('; ');
      if (v === null || v === undefined) v = '';
      v = String(v);
      if (v.includes(',') || v.includes('"') || v.includes('\n')) {
        v = '"' + v.replace(/"/g, '""') + '"';
      }
      return v;
    });
    rows.push(vals.join(','));
  });
  const blob = new Blob([rows.join('\n')], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'qobuz-nonsense-' + new Date().toISOString().substring(0,10) + '.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// â”€â”€ Direction by month (client-side fallback) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildDirectionByMonth(posts) {
  const result = {};
  posts.forEach(p => {
    const month = (p.date || '').substring(0, 7);
    if (!month) return;
    if (!result[month]) result[month] = { pro: 0, critical: 0, neutral: 0 };
    const d = p.direction || 'neutral';
    result[month][d] = (result[month][d] || 0) + 1;
  });
  return result;
}

// â”€â”€ Sentiment balance chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSentimentChart() {
  const byMonth = METADATA.by_direction_by_month || buildDirectionByMonth(allPosts);
  const months = getLast6Months();

  new Chart(document.getElementById('sentiment-chart'), {
    type: 'bar',
    data: {
      labels: months.map(m => formatMonth(m)),
      datasets: [
        {
          label: 'Pro-Qobuz',
          data: months.map(m => (byMonth[m] || {}).pro || 0),
          backgroundColor: 'rgba(194,255,160,0.6)',
          borderColor: '#c2ffa0',
          borderWidth: 1,
        },
        {
          label: 'Critical',
          data: months.map(m => (byMonth[m] || {}).critical || 0),
          backgroundColor: 'rgba(255,170,68,0.6)',
          borderColor: '#ffaa44',
          borderWidth: 1,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: '#a0a0c0', font: { size: 11 }, boxWidth: 12 } },
      },
      scales: {
        x: { stacked: true, ticks: { color: '#6b6b88', font: { size: 10 } }, grid: { color: '#2a2a3a' } },
        y: { stacked: true, ticks: { color: '#6b6b88', font: { size: 10 } }, grid: { color: '#2a2a3a' } },
      },
    },
  });
}

// â”€â”€ Top posts this week â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTopPostsPanel() {
  const now = new Date();
  const weekAgo = new Date(now - 7 * 24 * 3600 * 1000).toISOString();
  const topPosts = allPosts
    .filter(p => p.date && p.date >= weekAgo && (p.score || 0) > 0)
    .sort((a, b) => (b.score || 0) - (a.score || 0))
    .slice(0, 3);

  const container = document.getElementById('top-posts-list');
  if (!topPosts.length) {
    container.innerHTML = `<div style="color:var(--muted);font-size:12px;padding:12px 0">No scored posts in the last 7 days.</div>`;
    return;
  }
  const ranks = ['â‘ ', 'â‘¡', 'â‘¢'];
  container.innerHTML = topPosts.map((p, i) => `
    <div class="top-post-item">
      <div class="top-post-rank">${ranks[i]}</div>
      <div class="top-post-body">
        <div class="top-post-title">
          <a href="${escHtml(p.url)}" target="_blank" rel="noopener">${escHtml(p.title || (p.text||'').substring(0,100) || '(no title)')}</a>
        </div>
        <div class="top-post-meta">
          <span style="color:var(--ok)">â–² ${Number(p.score).toLocaleString()}</span>
          <span>${p.subreddit || p.source}</span>
          <span>${formatDate(p.date).split(',')[0]}</span>
        </div>
      </div>
    </div>`).join('');
}

// â”€â”€ Subreddit breakdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSubredditTable() {
  const counts = {};
  allPosts.forEach(p => {
    if (p.subreddit) counts[p.subreddit] = (counts[p.subreddit] || 0) + 1;
  });
  const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 8);
  if (!sorted.length) {
    document.getElementById('subreddit-table').innerHTML =
      `<div style="color:var(--muted);font-size:12px">No subreddit data.</div>`;
    return;
  }
  const max = sorted[0][1];
  document.getElementById('subreddit-table').innerHTML = sorted.map(([name, count]) => `
    <div class="subreddit-row">
      <span class="subreddit-name">${escHtml(name)}</span>
      <div class="subreddit-bar-wrap"><div class="subreddit-bar" style="width:${Math.round(count/max*100)}%"></div></div>
      <span class="subreddit-count">${count}</span>
    </div>`).join('');
}

// â”€â”€ Velocity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function displayVelocity() {
  const now = new Date();
  const weekAgo = new Date(now - 7 * 24 * 3600 * 1000).toISOString();
  const twoWeeksAgo = new Date(now - 14 * 24 * 3600 * 1000).toISOString();
  const thisWeek = allPosts.filter(p => p.date && p.date >= weekAgo).length;
  const lastWeek = allPosts.filter(p => p.date && p.date >= twoWeeksAgo && p.date < weekAgo).length;
  const el = document.getElementById('stat-velocity');
  if (!el) return;
  if (lastWeek === 0 && thisWeek === 0) { el.innerHTML = ''; return; }
  if (lastWeek === 0) {
    el.innerHTML = `<span class="velocity-badge velocity-up">new</span>`;
  } else {
    const pct = Math.round((thisWeek - lastWeek) / lastWeek * 100);
    const cls = pct > 0 ? 'velocity-up' : pct < 0 ? 'velocity-down' : 'velocity-flat';
    const arrow = pct > 0 ? 'â†‘' : pct < 0 ? 'â†“' : 'â†’';
    el.innerHTML = `<span class="velocity-badge ${cls}">${arrow}${Math.abs(pct)}%</span>`;
  }
}

// â”€â”€ Source breakdown chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSourceChart() {
  const bySource = METADATA.by_source || {};
  const labels = Object.keys(bySource);
  const data = Object.values(bySource);
  if (!labels.length) return;
  const colorMap = { reddit: '#ff5700', news: '#4a9eff', twitter: '#1da1f2', hackernews: '#ff6600' };

  new Chart(document.getElementById('source-chart'), {
    type: 'doughnut',
    data: {
      labels: labels.map(l => l === 'hackernews' ? 'Hacker News' : l.charAt(0).toUpperCase() + l.slice(1)),
      datasets: [{
        data: data,
        backgroundColor: labels.map(l => (colorMap[l] || '#6b6b88') + '88'),
        borderColor: labels.map(l => colorMap[l] || '#6b6b88'),
        borderWidth: 1,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right', labels: { color: '#a0a0c0', font: { size: 11 }, boxWidth: 12 } },
      },
    },
  });
}

// â”€â”€ Language breakdown chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildLanguageChart() {
  const byLang = METADATA.by_language || {};
  const labels = Object.keys(byLang);
  const data = Object.values(byLang);
  if (!labels.length) return;
  const colorMap = { en: '#4a9eff', fr: '#0055a4', de: '#dd0000', es: '#ffc400', pt: '#006600', it: '#009246', nl: '#ff6600', unknown: '#6b6b88' };

  new Chart(document.getElementById('language-chart'), {
    type: 'doughnut',
    data: {
      labels: labels.map(l => LANG_NAMES[l] || l),
      datasets: [{
        data: data,
        backgroundColor: labels.map(l => (colorMap[l] || '#6b6b88') + '88'),
        borderColor: labels.map(l => colorMap[l] || '#6b6b88'),
        borderWidth: 1,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right', labels: { color: '#a0a0c0', font: { size: 11 }, boxWidth: 12 } },
      },
    },
  });
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>

<!-- Author history panel -->
<div class="author-panel-overlay" id="author-panel-overlay" onclick="closeAuthorPanel()"></div>
<div class="author-panel" id="author-panel">
  <div class="author-panel-header">
    <div class="author-panel-title" id="author-panel-title">@author</div>
    <button class="author-panel-close" onclick="closeAuthorPanel()">âœ•</button>
  </div>
  <div class="author-panel-body" id="author-panel-body"></div>
</div>

</body>
</html>
